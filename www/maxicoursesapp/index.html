<script>
const API = "/maxicoursesapp/api/compare_api.php?preset=coca175";
const $tbl = document.getElementById("tbl");
const $tb = $tbl.querySelector("tbody");
const $err = document.getElementById("error");
const $status = document.getElementById("status");
const $btn = document.getElementById("refresh");

function host(url){ try{ return new URL(url).hostname.replace(/^www\./,''); }catch{ return url; } }
function euro(x){ return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(x); }

async function load(){
  $status.textContent = "Chargement…";
  $status.className = "";
  $err.hidden = true; $tbl.hidden = true; $tb.innerHTML = "";
  try{
    const r = await fetch(API, {
      cache: "no-store",
      headers: { "Accept": "application/json" }  // Force la réponse JSON (évite l'UI HTML de l'API)
    });
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    if(!j.ok){ throw new Error("Réponse API non OK"); }
    const rows = (j.results||[]).slice().sort((a,b)=>(a.price??1e9)-(b.price??1e9));
    for(const it of rows){
      const tr = document.createElement("tr");
      const brand = host(it.url);
      tr.innerHTML = `
        <td><a href="${it.url}" target="_blank" rel="noopener">${brand}</a>
            ${it.seeded?'<span class="muted"> (cache)</span>':''}
        </td>
        <td>${it.price!=null? euro(it.price): '<span class="muted">—</span>'}</td>
        <td>${(it.title||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</td>`;
      $tb.appendChild(tr);
    }
    if(!rows.length){ $err.textContent="Aucun résultat."; $err.hidden=false; }
    else { $tbl.hidden=false; }
    $status.textContent = "OK";
    $status.className = "ok";
  }catch(e){
    $err.textContent = "Erreur de chargement.";
    $err.hidden = false;
    $status.textContent = "";
  }
}

$btn.addEventListener("click", load);
load();
</script>