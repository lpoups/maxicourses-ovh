<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MaxiCourses – Liste de course</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root {
      color-scheme: light dark;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 24px;
      background: #f6f7fb;
      color: #111;
      line-height: 1.5;
    }
    header {
      margin-bottom: 24px;
    }
    h1 {
      font-size: 1.8rem;
      margin: 0 0 8px;
    }
    .masthead {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand img {
      height: 52px;
      width: auto;
      border-radius: 12px;
      background: linear-gradient(180deg,#071F54 0%,#0B2F78 100%);
      padding: 6px 10px;
      box-shadow: 0 6px 18px rgba(7,31,84,0.28);
    }
    .meta {
      font-size: 0.9rem;
      color: #475569;
    }
    .descriptor {
      margin-bottom: 24px;
    }
    .product-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 24px rgba(15,23,42,0.12);
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .product-card--compact {
      padding: 14px;
      gap: 16px;
    }
    .product-media {
      flex: 0 0 130px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .product-card--compact .product-media {
      flex-basis: 120px;
    }
    .product-thumb {
      width: 130px;
      height: 130px;
      border-radius: 14px;
      background: #f3f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .product-card--compact .product-thumb {
      width: 115px;
      height: 115px;
    }
    .product-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .product-thumb__placeholder {
      font-size: 0.85rem;
      color: #8891aa;
      padding: 12px;
      text-align: center;
    }
    .product-nutri {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
      color: #334155;
    }
    .product-nutri img {
      height: 30px;
    }
    .product-card--compact .product-nutri img {
      height: 28px;
    }
    .product-body {
      flex: 1;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .product-card--compact .product-body {
      min-width: 220px;
      gap: 10px;
    }
    .product-brand {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
    }
    .product-title {
      margin: 0;
      font-size: 1.25rem;
      color: #0f172a;
    }
    .product-card--compact .product-title {
      font-size: 1.05rem;
    }
    .product-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .product-summary span {
      background: #eef2ff;
      color: #4338ca;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
    }
    .product-details {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      margin: 0;
    }
    .product-details dt {
      margin: 0 0 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #94a3b8;
    }
    .product-details dd {
      margin: 0;
      font-size: 0.82rem;
      color: #0f172a;
    }
    .product-map {
      flex: 0 0 220px;
      height: 180px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.12);
      overflow: hidden;
      position: relative;
    }
    .product-card--compact .product-map {
      flex-basis: 200px;
      height: 165px;
    }
    .product-map__canvas {
      position: absolute;
      inset: 0;
    }
    .product-map__label {
      position: absolute;
      bottom: 12px;
      right: 12px;
      font-size: 11px;
      color: #475569;
      background: rgba(255,255,255,0.9);
      padding: 4px 10px;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(15,23,42,0.18);
    }
    .product-map--static .leaflet-container,
    .product-map--static .leaflet-pane,
    .product-map--static .leaflet-control-container {
      pointer-events: none !important;
    }
    .product-map--static .leaflet-control-container {
      display: none;
    }
    .product-map--modal {
      width: 560px;
      height: 360px;
      margin: 0;
    }
    .product-map__label--modal {
      font-size: 13px;
      padding: 6px 12px;
    }
    .map-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    .map-modal[hidden] {
      display: none;
    }
    .map-modal__backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15,23,42,0.45);
    }
    .map-modal__content {
      position: relative;
      background: transparent;
      padding: 0;
      border-radius: 20px;
      box-shadow: 0 24px 60px rgba(15,23,42,0.35);
      overflow: hidden;
      z-index: 1001;
    }
    .map-modal__close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.9);
      color: #1f2937;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(15,23,42,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .map-modal__close:hover {
      background: #fff;
    }
    body.modal-open {
      overflow: hidden;
    }
    #primary-map,
    #map-modal {
      display: none !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,0.08);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    thead {
      background: #e2e8f0;
      text-transform: uppercase;
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      color: #475569;
    }
    th, td {
      padding: 10px 14px;
      border-bottom: 1px solid #e2e8f0;
      vertical-align: top;
    }
    td:first-child, th:first-child {
      white-space: nowrap;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .product-cell {
      max-width: 240px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #4a5568;
    }
    .status-ok {
      color: #047857;
      font-weight: 600;
    }
    .status-error {
      color: #b91c1c;
      font-weight: 600;
    }
    .status-warn {
      color: #b45309;
      font-weight: 600;
    }
    .price {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    .meta-cell {
      font-size: 0.8rem;
      color: #64748b;
    }
    .table-logo {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .table-logo img {
      height: 24px;
      width: auto;
      display: block;
    }
    .table-logo__label {
      font-size: 0.7rem;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .price-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(6,95,70,0.14);
      color: #065f46;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .best-price-banner {
      margin: 0 0 14px;
      padding: 10px 14px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(16,185,129,0.18), rgba(16,185,129,0.06));
      color: #065f46;
      font-size: 0.95rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .best-price-banner::before {
      content: '★';
    }
    .notes {
      font-size: 0.9rem;
      color: #475569;
      white-space: pre-line;
      margin-bottom: 32px;
    }
    .notes[hidden] {
      display: none;
    }
    .link {
      color: #2563eb;
      text-decoration: none;
    }
    .link:hover {
      text-decoration: underline;
    }
    .product-block {
      margin-top: 32px;
    }
    .product-block h2 {
      margin: 0 0 14px;
      font-size: 1.25rem;
      color: #0f172a;
    }
    #primary-section.product-block {
      margin-top: 0;
    }
    .image-preview {
      margin: 18px 0 32px;
    }
    .best-offer td {
      background: #f0fdf4;
    }
    .empty-state {
      font-size: 0.95rem;
      color: #64748b;
    }
  </style>
</head>
<body>
  <header class="masthead">
    <div class="brand">
      <img src="../assets/logo_blanc_maxicourses.png" alt="MaxiCourses" />
      <h1>Liste de course</h1>
    </div>
    <div class="meta" id="run-meta">Chargement…</div>
  </header>

  <section class="descriptor product-block" id="primary-section" hidden></section>

  <div class="image-preview" id="primary-image-preview" hidden>
    <img id="primary-image-preview-img" alt="Dernière image" />
    <div class="meta">Image terrain (pipeline)</div>
  </div>

  <template id="product-card-template">
    <div class="product-card">
      <div class="product-media">
        <div class="product-thumb">
          <div class="product-thumb__placeholder">Image indisponible</div>
        </div>
        <div class="product-nutri" data-role="nutri"></div>
      </div>
      <div class="product-body">
        <div class="product-brand" data-role="brand" hidden></div>
        <h3 class="product-title" data-role="title"></h3>
        <div class="product-summary">
          <span class="product-summary__quantity" data-role="quantity" hidden></span>
          <span class="product-summary__category" data-role="category" hidden></span>
        </div>
        <dl class="product-details">
          <div>
            <dt>EAN</dt>
            <dd data-role="ean">—</dd>
          </div>
          <div>
            <dt>Source</dt>
            <dd data-role="source">—</dd>
          </div>
        </dl>
      </div>
      <div class="product-map product-map--static" data-role="map" hidden>
        <div class="product-map__canvas" data-role="map-canvas"></div>
        <div class="product-map__label" data-role="map-label">Bordeaux Métropole</div>
      </div>
    </div>
  </template>

  <div class="map-modal" id="map-modal" hidden>
    <div class="map-modal__backdrop" data-close-map></div>
    <div class="map-modal__content">
      <button class="map-modal__close" type="button" data-close-map aria-label="Fermer la carte">×</button>
      <div class="product-map product-map--modal" id="store-map-modal">
        <div id="store-map-modal-canvas" class="product-map__canvas"></div>
        <div class="product-map__label product-map__label--modal">Bordeaux Métropole</div>
      </div>
    </div>
  </div>

  <div id="comparisons"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const PRIMARY_DATASET = {
      ean: '3124480200433',
      heading: 'Liste de course',
      resultUrl: null
    };

    const EXTRA_DATASETS = [
      {
        ean: '5000112611861',
        heading: 'Comparatif (Test Coca-Cola 1,75 L)',
        resultUrl: '../results/test-5000112611861/latest.json'
      },
      {
        ean: '5411188118961',
        heading: 'Comparatif (Dessert végétal soja nature ALPRO)',
        resultUrl: '../results/test-5411188118961/latest.json'
      }
    ];

    const SUMMARY_URL = '../results/summary.json';
    const MANUAL_DESCRIPTORS_URL = '../manual_descriptors.json';

    const MANUAL_COMPARISON = {};

    const LOGO_BASE = new URL('../assets/logos/', window.location.href).href;
    const LOGOS = {
      carrefour: 'carrefour.png',
      carrefour_city: 'carrefour.png',
      carrefour_market: 'carrefour.png',
      leclerc: 'leclerc.png',
      leclerc_drive: 'leclerc.png',
      intermarche: 'intermarche.png',
      auchan: 'auchan.png',
      chronodrive: 'chronodrive.png'
    };

    const DISPLAY_NAMES = {
      carrefour: 'Carrefour',
      carrefour_city: 'Carrefour City',
      carrefour_market: 'Carrefour Market',
      leclerc: 'E.Leclerc Drive',
      leclerc_drive: 'E.Leclerc Drive',
      intermarche: 'Intermarché',
      auchan: 'Auchan',
      chronodrive: 'Chronodrive'
    };

    const STORE_LOCATIONS = {
      carrefour_city: { lat: 44.8573603, lon: -0.568063, label: 'Carrefour City · Bordeaux Balguerie' },
      carrefour_market: { lat: 44.8488597, lon: -0.5839625, label: 'Carrefour Market · Fondaudège' },
      leclerc_drive: { lat: 44.8461492, lon: -0.5792079, label: 'E.Leclerc Relais · Bordeaux Fondaudège' },
      intermarche: { lat: 44.8066547, lon: -0.5750164, label: 'Intermarché · Talence Toulouse' },
      auchan: { lat: 44.806195, lon: -0.5910973, label: 'Auchan Supermarché · Talence' },
      chronodrive: { lat: 44.8589595, lon: -0.6768561, label: 'Chronodrive · Bordeaux Magudas' }
    };

    const FALLBACK_NUTRI_IMAGES = {
      a: '../assets/nutriscore/nutriscore-a.svg',
      b: '../assets/nutriscore/nutriscore-b.svg',
      c: '../assets/nutriscore/nutriscore-c.svg',
      d: '../assets/nutriscore/nutriscore-d.svg',
      e: '../assets/nutriscore/nutriscore-e.svg'
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const [manualDescriptors, summary] = await Promise.all([
        fetchJson(MANUAL_DESCRIPTORS_URL),
        fetchJson(withCacheBuster(SUMMARY_URL))
      ]);

      const primaryData = await fetchDataset(PRIMARY_DATASET);
      renderPrimary(primaryData, summary, manualDescriptors);

      for (const config of EXTRA_DATASETS) {
        const dataset = await fetchDataset(config);
        renderComparisonSection(config, dataset, summary, manualDescriptors);
      }
    });

    async function fetchDataset(config) {
      if (!config.resultUrl) {
        return { data: null };
      }
      const data = await fetchJson(withCacheBuster(config.resultUrl));
      return { data };
    }

    async function fetchJson(url) {
      if (!url) return null;
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch (err) {
        console.warn('fetchJson failed', url, err);
        return null;
      }
    }

    function withCacheBuster(url) {
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}_=${Date.now()}`;
    }

    function createProductCard(descriptor, options = {}) {
      const template = document.getElementById('product-card-template');
      if (!template) return null;
      const root = template.content.firstElementChild.cloneNode(true);
      if (options.compact) {
        root.classList.add('product-card--compact');
      }

      let titleEl = root.querySelector('[data-role="title"]');
      if (options.headingLevel && options.headingLevel !== 3) {
        const headingTag = `h${options.headingLevel}`;
        const replacement = document.createElement(headingTag);
        replacement.className = titleEl.className;
        replacement.dataset.role = 'title';
        titleEl.replaceWith(replacement);
        titleEl = replacement;
      }

      const brandEl = root.querySelector('[data-role="brand"]');
      if (descriptor.brand) {
        brandEl.textContent = descriptor.brand;
        brandEl.hidden = false;
      } else {
        brandEl.hidden = true;
      }

      titleEl.textContent = descriptor.title || descriptor.name || 'Produit';

      const qtyEl = root.querySelector('[data-role="quantity"]');
      if (descriptor.quantity) {
        qtyEl.textContent = descriptor.quantity;
        qtyEl.hidden = false;
      } else {
        qtyEl.hidden = true;
      }

      const catEl = root.querySelector('[data-role="category"]');
      if (descriptor.categories) {
        catEl.textContent = extractCategory(descriptor.categories);
        catEl.hidden = false;
      } else {
        catEl.hidden = true;
      }

      const eanEl = root.querySelector('[data-role="ean"]');
      eanEl.textContent = descriptor.ean || '—';

      const sourceEl = root.querySelector('[data-role="source"]');
      sourceEl.textContent = descriptor.source || '—';

      const thumbEl = root.querySelector('.product-thumb');
      thumbEl.innerHTML = '';
      const imageSrc = descriptor.image ? toAbsolute(descriptor.image) : '';
      if (imageSrc) {
        const img = document.createElement('img');
        img.src = imageSrc;
        img.alt = descriptor.title || descriptor.name || '';
        thumbEl.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'product-thumb__placeholder';
        placeholder.textContent = 'Image indisponible';
        thumbEl.appendChild(placeholder);
      }

      const nutriEl = root.querySelector('[data-role="nutri"]');
      nutriEl.innerHTML = '';
      const nutriGrade = descriptor.nutriscore_grade;
      const nutriImg = descriptor.nutriscore_image
        ? toAbsolute(descriptor.nutriscore_image)
        : FALLBACK_NUTRI_IMAGES[(nutriGrade || '').toLowerCase()];
      if (nutriImg) {
        const label = document.createElement('span');
        label.textContent = 'Nutri-score :';
        const img = document.createElement('img');
        img.src = nutriImg;
        img.alt = nutriGrade ? `Nutri-score ${nutriGrade.toUpperCase()}` : 'Nutri-score';
        nutriEl.appendChild(label);
        nutriEl.appendChild(img);
      } else if (nutriGrade) {
        nutriEl.textContent = `Nutri-score : ${nutriGrade.toUpperCase()}`;
      }

      const mapEl = root.querySelector('[data-role="map"]');
      const mapCanvas = root.querySelector('[data-role="map-canvas"]');
      const mapLabel = root.querySelector('[data-role="map-label"]');
      let mapRefs = null;
      if (options.map) {
        const labelText = options.map.label || descriptor.map_label || '';
        if (labelText) {
          mapLabel.textContent = labelText;
        }
        mapEl.hidden = false;
        if (options.map.idPrefix) {
          mapEl.id = `${options.map.idPrefix}-map`;
          mapCanvas.id = `${options.map.idPrefix}-map-canvas`;
        }
        mapRefs = { container: mapEl, canvas: mapCanvas, label: mapLabel };
      } else {
        mapEl.remove();
      }

      return { element: root, map: mapRefs };
    }

    function renderProductBlock(target, {
      heading,
      descriptor,
      rows = [],
      best,
      cardOptions = {}
    }) {
      if (!target || !descriptor) return { card: null };
      target.innerHTML = '';
      target.hidden = false;
      target.classList.add('product-block');

      if (heading) {
        const headingEl = document.createElement('h2');
        headingEl.textContent = heading;
        target.appendChild(headingEl);
      }

      const card = createProductCard(descriptor, cardOptions);
      if (card) {
        target.appendChild(card.element);
      }

      if (best) {
        const banner = document.createElement('div');
        banner.className = 'best-price-banner';
        banner.textContent = `Top prix relevé : ${best.priceLabel}${best.store ? ` · ${best.store}` : ''}`;
        target.appendChild(banner);
      }

      if (rows.length) {
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Enseigne</th>
              <th>Produit</th>
              <th>Statut</th>
              <th>Prix pack</th>
              <th>Prix / unité</th>
              <th>Magasin / Note</th>
              <th>Maj</th>
              <th>Liens</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        renderTable(table.querySelector('tbody'), rows, best?.value);
        target.appendChild(table);
      } else {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = 'Aucune donnée collectée pour le moment.';
        target.appendChild(empty);
      }

      return { card };
    }

    function renderPrimary(dataset, summary, manualDescriptors) {
      const section = document.getElementById('primary-section');
      const metaEl = document.getElementById('run-meta');
      const previewEl = document.getElementById('primary-image-preview');
      const previewImg = document.getElementById('primary-image-preview-img');

      const summaryBlock = summary?.[PRIMARY_DATASET.ean] || null;
      const rows = buildRows(PRIMARY_DATASET.ean, dataset.data, summaryBlock);

      const descriptor = resolveDescriptor(PRIMARY_DATASET.ean, dataset.data, manualDescriptors);
      const best = pickBestPrice(rows);

      const { card } = renderProductBlock(section, {
        heading: null,
        descriptor,
        rows,
        best,
        cardOptions: { compact: true, headingLevel: 2 }
      });

      if (previewEl && previewImg) {
        if (dataset?.data?.image_path) {
          const relative = dataset.data.image_path.replace(/^.*www\//, '../');
          previewImg.src = relative;
          previewEl.hidden = false;
        } else {
          previewEl.hidden = true;
        }
      }

      const lastUpdate = computeLastUpdate(rows);
      metaEl.textContent = lastUpdate
        ? `EAN ${PRIMARY_DATASET.ean} · relevé le ${formatDateTime(lastUpdate)}`
        : `EAN ${PRIMARY_DATASET.ean}`;

      if (card && card.map) {
        renderMapMarkers(rows);
        setupMapModal();
      }
    }

    function renderComparisonSection(config, dataset, summary, manualDescriptors) {
      const container = document.getElementById('comparisons');
      const summaryBlock = summary?.[config.ean] || null;
      const rows = buildRows(config.ean, dataset.data, summaryBlock);

      const descriptor = resolveDescriptor(config.ean, dataset.data, manualDescriptors);
      const best = pickBestPrice(rows);

      const section = document.createElement('section');
      section.className = 'product-block';
      section.id = `comparison-${config.ean}`;

      renderProductBlock(section, {
        heading: null,
        descriptor,
        rows,
        best,
        cardOptions: { compact: true }
      });

      container.appendChild(section);
    }

    function buildRows(ean, data, summaryBlock) {
      const map = new Map();
      if (summaryBlock) {
        Object.entries(summaryBlock).forEach(([adapter, entry]) => {
          upsertRow(map, adapter, {
            payload: entry.payload || {},
            status: entry.status,
            updatedAt: entry.updated_at,
            error: entry.error,
            storeQuery: entry.store_query
          });
        });
      }
      (data?.adapters || []).forEach((adapterEntry) => {
        upsertRow(map, adapterEntry.adapter, {
          payload: adapterEntry.payload || {},
          status: adapterEntry.status,
          updatedAt: adapterEntry.finished_at,
          error: adapterEntry.error,
          storeQuery: adapterEntry.store_query
        });
      });

      applyManualFallbacks(map, ean);

      return Array.from(map.values())
        .map(finalizeRow)
        .sort((a, b) => {
          if (a.priceValue === b.priceValue) {
            return (a.displayName || '').localeCompare(b.displayName || '');
          }
          return a.priceValue - b.priceValue;
        });
    }

    function upsertRow(map, adapterName, entry) {
      const base = normalizeAdapterName(adapterName);
      let row = map.get(base);
      if (!row) {
        row = {
          adapterName: base,
          rawAdapters: new Set(),
          payload: {},
          status: '',
          updatedAt: null,
          error: null,
          storeQuery: null
        };
      }
      row.rawAdapters.add(adapterName);
      row.status = entry.status || row.status;
      row.updatedAt = entry.updatedAt || row.updatedAt;
      row.error = entry.error || row.error;
      row.storeQuery = entry.storeQuery || row.storeQuery;
      row.payload = mergePayloads(row.payload, entry.payload || {});
      map.set(base, row);
    }

    function finalizeRow(row) {
      const payload = row.payload || {};
      return {
        adapterName: row.adapterName,
        payload,
        status: row.status,
        updatedAt: row.updatedAt,
        error: row.error,
        storeQuery: row.storeQuery,
        priceValue: parsePriceValue(payload.price),
        displayName: DISPLAY_NAMES[row.adapterName] || row.adapterName,
        rawAdapters: Array.from(row.rawAdapters || [])
      };
    }

    function applyManualFallbacks(map, ean) {
      const entries = MANUAL_COMPARISON[ean];
      if (!entries || !entries.length) return;
      entries.forEach((entry) => {
        const base = normalizeAdapterName(entry.adapter);
        const existing = map.get(base);
        const hasPrice = existing && existing.payload && existing.payload.price;
        if (existing && hasPrice) {
          return;
        }
        upsertRow(map, entry.adapter, {
          payload: entry.payload || {},
          status: entry.status,
          updatedAt: entry.updated_at,
          error: entry.error || null,
          storeQuery: entry.store_query || null
        });
      });
    }

    const MAP_CENTER = [44.8468, -0.583];
    const mapInstances = {};
    const markerGroups = {};
    let latestRows = [];
    let mapModalSetup = false;
    let mapModalHandlers = null;

    const ensureLeaflet = () => typeof L !== 'undefined';

    function ensureMap(canvasId, interactive) {
      if (!ensureLeaflet()) return null;
      let map = mapInstances[canvasId];
      if (!map) {
        map = L.map(canvasId, {
          center: MAP_CENTER,
          zoom: interactive ? 12 : 11,
          zoomControl: interactive
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        if (!interactive) {
          map.dragging.disable();
          map.touchZoom.disable();
          map.scrollWheelZoom.disable();
          map.doubleClickZoom.disable();
          map.boxZoom.disable();
          map.keyboard.disable();
          if (map.zoomControl) {
            map.zoomControl.remove();
          }
        }
        markerGroups[canvasId] = L.layerGroup().addTo(map);
        mapInstances[canvasId] = map;
      } else {
        markerGroups[canvasId].clearLayers();
        map.setView(MAP_CENTER, interactive ? 12 : 11);
      }
      return map;
    }

    function addMarkersToMap(canvasId, rows, scale, interactive) {
      const map = ensureMap(canvasId, interactive);
      if (!map) return;
      const group = markerGroups[canvasId];
      group.clearLayers();
      const bounds = [];

      rows.forEach((row) => {
        const location = STORE_LOCATIONS[row.adapterName];
        if (!location) return;
        const logoSrc = logoFor(row.adapterName, row.rawAdapters || []);
        const displayName = row.displayName || DISPLAY_NAMES[row.adapterName] || row.adapterName;
        const icon = createMarkerIcon(displayName, logoSrc);
        const marker = L.marker([location.lat, location.lon], { icon });
        if (interactive) {
          const tooltip = location.label || displayName;
          marker.bindTooltip(tooltip, { direction: 'top', offset: [0, -6] });
          marker.bindPopup(formatLocationTooltip(location) || displayName, { closeButton: false, offset: [0, -12 * scale] });
        }
        group.addLayer(marker);
        bounds.push([location.lat, location.lon]);
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [28, 28] });
        if (!interactive) {
          map.once('moveend', () => {
            if (map.getZoom() > 13) {
              map.setZoom(13);
            }
          });
        } else {
          setTimeout(() => map.invalidateSize(), 160);
        }
      }
    }

    function renderMapMarkers(rows) {
      latestRows = rows;
      addMarkersToMap('primary-map-canvas', rows, 0.85, false);
      addMarkersToMap('store-map-modal-canvas', rows, 1.1, true);
      const hasLocations = rows.some((row) => STORE_LOCATIONS[row.adapterName]);
      const mapContainer = document.getElementById('primary-map');
      if (mapContainer) {
        mapContainer.hidden = !hasLocations;
      }
    }

    function setupMapModal() {
      const modal = document.getElementById('map-modal');
      const mapEl = document.getElementById('primary-map');
      if (!modal || !mapEl) return;

      if (!mapModalSetup) {
        const closeElements = modal.querySelectorAll('[data-close-map]');

        const closeModal = () => {
          modal.hidden = true;
          document.body.classList.remove('modal-open');
        };

        const openModal = () => {
          modal.hidden = false;
          document.body.classList.add('modal-open');
          renderMapMarkers(latestRows);
          setTimeout(() => {
            const modalMap = mapInstances['store-map-modal-canvas'];
            if (modalMap) {
              modalMap.invalidateSize();
            }
          }, 200);
        };

        closeElements.forEach((el) => el.addEventListener('click', closeModal));
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && !modal.hidden) {
            closeModal();
          }
        });

        mapModalHandlers = { openModal, closeModal };
        mapModalSetup = true;
      }

      if (mapModalHandlers && mapEl.dataset.modalBound !== '1') {
        mapEl.addEventListener('click', mapModalHandlers.openModal);
        mapEl.dataset.modalBound = '1';
      }
    }

    function formatLocationTooltip(location) {
      const lines = [location.label];
      if (location.address) {
        lines.push(location.address);
      }
      return lines.filter(Boolean).map((line) => escapeHtml(line)).join('<br />');
    }

    function renderTable(tbody, rows, bestValue) {
      tbody.innerHTML = '';
      rows.forEach((row) => {
        const payload = row.payload || {};
        const priceText = formatPrice(payload.price);
        const unitPrice = payload.unit_price || payload.price_unit || payload.price_per_unit || '';
        const store = payload.store || payload.note || row.storeQuery || '';
        const productName = cleanProductName(payload.product_name || payload.title || '');
        const updatedLabel = row.updatedAt ? formatDateTime(row.updatedAt) : '—';
        const { label: statusLabel, className: statusClass } = formatStatus(row.status);
        const logoSrc = logoFor(row.adapterName, row.rawAdapters);
        const suffix = suffixLabel(row.adapterName);
        const displayName = DISPLAY_NAMES[row.adapterName] || row.adapterName;
        const isBest = Number.isFinite(bestValue) && Number.isFinite(row.priceValue) && Math.abs(row.priceValue - bestValue) < 0.001;

        const tr = document.createElement('tr');
        if (isBest) {
          tr.className = 'best-offer';
        }

        const nameCell = document.createElement('td');
        if (logoSrc) {
          nameCell.innerHTML = `<div class="table-logo"><img src="${logoSrc}" alt="${escapeHtml(displayName)}" />${suffix ? `<span class="table-logo__label">${escapeHtml(suffix)}</span>` : ''}</div>`;
        } else {
          nameCell.textContent = displayName;
        }

        const productCell = document.createElement('td');
        productCell.className = 'product-cell';
        productCell.title = productName;
        productCell.textContent = productName || '—';

        const statusCell = document.createElement('td');
        statusCell.className = statusClass;
        statusCell.textContent = statusLabel;

        const priceCell = document.createElement('td');
        priceCell.className = 'price';
        if (priceText) {
          priceCell.innerHTML = `${escapeHtml(priceText)}${isBest ? '<span class="price-badge">TOP PRIX</span>' : ''}`;
        } else {
          priceCell.textContent = '—';
        }

        const unitCell = document.createElement('td');
        unitCell.textContent = unitPrice || '—';

        const storeCell = document.createElement('td');
        storeCell.textContent = store || '—';

        const updatedCell = document.createElement('td');
        updatedCell.className = 'meta-cell';
        updatedCell.textContent = updatedLabel;

        const linkCell = document.createElement('td');
        if (payload.url) {
          const link = document.createElement('a');
          link.className = 'link';
          link.href = payload.url;
          link.target = '_blank';
          link.rel = 'noopener';
          link.textContent = 'Ouvrir';
          linkCell.appendChild(link);
        }

        tr.appendChild(nameCell);
        tr.appendChild(productCell);
        tr.appendChild(statusCell);
        tr.appendChild(priceCell);
        tr.appendChild(unitCell);
        tr.appendChild(storeCell);
        tr.appendChild(updatedCell);
        tr.appendChild(linkCell);

        if (row.error && !row.priceValue) {
          const err = document.createElement('div');
          err.className = 'notes';
          err.textContent = row.error;
          linkCell.appendChild(err);
        }

        tbody.appendChild(tr);
      });
    }

    function resolveDescriptor(ean, data, manualDescriptors) {
      const manual = manualDescriptors?.[ean];
      if (manual) {
        return {
          ean,
          title: manual.name,
          name: manual.name,
          brand: manual.brand,
          quantity: manual.quantity,
          categories: manual.categories,
          image: manual.image,
          nutriscore_grade: manual.nutriscore_grade,
          nutriscore_image: manual.nutriscore_image,
          source: manual.source,
          description: manual.description,
          note: manual.note || ''
        };
      }
      const descriptor = data?.reference || {};
      return { ...descriptor, ean };
    }

    function computeLastUpdate(rows) {
      let max = null;
      rows.forEach((row) => {
        if (row.updatedAt && (!max || new Date(row.updatedAt) > new Date(max))) {
          max = row.updatedAt;
        }
      });
      return max;
    }

    function pickBestPrice(rows) {
      const priced = rows.filter((row) => Number.isFinite(row.priceValue));
      if (!priced.length) return null;
      let best = priced[0];
      for (const row of priced.slice(1)) {
        if (row.priceValue < best.priceValue) {
          best = row;
        }
      }
      const payload = best.payload || {};
      return {
        value: best.priceValue,
        priceLabel: formatPrice(payload.price) || `${best.priceValue.toFixed(2)} €`,
        store: payload.store || DISPLAY_NAMES[best.adapterName] || best.adapterName
      };
    }

    function createMarkerIcon(displayName, logoSrc) {
      const width = 88;
      const height = 48;
      const paddingY = 10;
      const paddingX = 12;
      const safeName = escapeHtml(displayName || '');
      let innerHtml;
      if (logoSrc) {
        innerHtml = `<img src="${logoSrc}" alt="${safeName}" style="width:100%;height:100%;object-fit:contain;"/>`;
      } else {
        const fallback = safeName.charAt(0) || '•';
        innerHtml = `<span style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:1.1rem;font-weight:600;color:#1f2937;">${fallback}</span>`;
      }
      const wrapperStyle = `width:${width}px;height:${height}px;padding:${paddingY}px ${paddingX}px;border-radius:${Math.round(height)}px;background:rgba(255,255,255,0.95);border:1px solid rgba(15,23,42,0.12);box-shadow:0 12px 28px rgba(15,23,42,0.22);box-sizing:border-box;`;
      return L.divIcon({
        className: 'map-logo-icon',
        html: `<div style="${wrapperStyle}">${innerHtml}</div>`,
        iconSize: [width, height],
        iconAnchor: [width / 2, height / 2]
      });
    }

    function mergePayloads(current, incoming) {
      const result = { ...current };
      Object.entries(incoming || {}).forEach(([key, value]) => {
        if (value === null || value === undefined || value === '') return;
        result[key] = value;
      });
      return result;
    }

    function parsePriceValue(value) {
      if (value === null || value === undefined || value === '') return Number.POSITIVE_INFINITY;
      const normalized = String(value).replace(/[^0-9,\.]/g, '').replace(',', '.');
      const num = parseFloat(normalized);
      return Number.isFinite(num) ? num : Number.POSITIVE_INFINITY;
    }

    function formatPrice(value) {
      if (!value) return '';
      const trimmed = String(value).trim();
      if (!trimmed) return '';
      return trimmed.includes('€') ? trimmed : `${trimmed} €`;
    }

    function formatDateTime(iso) {
      if (!iso) return '—';
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return iso;
      return date.toLocaleString('fr-FR');
    }

    function formatStatus(status) {
      const upper = (status || '').toUpperCase();
      if (upper === 'OK') return { label: 'dispo', className: 'status-ok' };
      if (upper === 'NON DISPONIBLE' || upper === 'INDISPONIBLE' || upper === 'NO_RESULTS') {
        return { label: 'non dispo', className: 'status-error' };
      }
      if (!upper) return { label: 'inconnu', className: 'status-warn' };
      return { label: upper.replace(/_/g, ' ').toLowerCase(), className: 'status-warn' };
    }

    function normalizeAdapterName(name) {
      return (name || '').replace(/_manual$/, '');
    }

    function logoFor(adapterName, rawAdapters = []) {
      const key = normalizeAdapterName(adapterName);
      if (LOGOS[key]) return `${LOGO_BASE}${LOGOS[key]}`;
      for (const candidate of rawAdapters) {
        const normalized = normalizeAdapterName(candidate);
        if (LOGOS[normalized]) {
          return `${LOGO_BASE}${LOGOS[normalized]}`;
        }
      }
      return null;
    }

    function suffixLabel(adapterName) {
      const key = normalizeAdapterName(adapterName).toLowerCase();
      if (!key.startsWith('carrefour')) return '';
      if (key.includes('market')) return 'Market';
      if (key.includes('city')) return 'City';
      if (key.includes('express')) return 'Express';
      if (key.includes('contact')) return 'Contact';
      if (key.includes('montagne')) return 'Montagne';
      return '';
    }

    function cleanProductName(value) {
      if (!value) return '';
      return String(value).replace(/\s+/g, ' ').trim();
    }

    function toAbsolute(path) {
      if (!path) return '';
      if (String(path).startsWith('data:')) return path;
      try {
        return new URL(path, window.location.href).href;
      } catch (err) {
        return path;
      }
    }

    function escapeHtml(value) {
      if (value == null) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function extractCategory(raw) {
      if (!raw) return '';
      const parts = String(raw).split(',').map((part) => part.trim()).filter(Boolean);
      return parts.length ? parts[parts.length - 1] : raw;
    }
  </script>
</body>
</html>
